const DATA = {
  "tronc-commun": {
    label: "Tronc commun",
    description: "Analyse, programmation et bases scientifiques.",
    filieres: {
      "maths-fondamentales": {
        label: "Math√©matiques fondamentales",
        description: "Analyse, alg√®bre et physique pour d√©buter.",
        modules: [
          {
            title: "Analyse I",
            resources: [
              {
                url: "https://drive.google.com/file/d/1aExampleMathAnalyse1/view",
                label: "üìÑ Cours PDF ‚Äì Analyse I",
              },
              {
                url: "https://drive.google.com/file/d/1bExampleMathAnalyse1TD/view",
                label: "üìù TD ‚Äì Analyse I",
              },
            ],
          },
          {
            title: "Algorithmique I",
            resources: [
              {
                url: "https://drive.google.com/file/d/1cExampleAlgoCours/view",
                label: "üìÑ Cours PDF ‚Äì Algorithmique I",
              },
              {
                url: "https://drive.google.com/file/d/1dExampleAlgoTP/view",
                label: "üíª TP ‚Äì Algorithmique I",
              },
            ],
          },
          {
            title: "Physique G√©n√©rale",
            resources: [
              {
                url: "https://drive.google.com/file/d/1eExamplePhysique/view",
                label: "üìΩÔ∏è Vid√©o ‚Äì Cin√©matique",
              },
            ],
          },
        ],
      },
      "informatique-intro": {
        label: "Informatique &amp; algorithmique",
        description: "Programmation et structures de donn√©es.",
        modules: [
          {
            title: "Programmation C",
            resources: [
              {
                url: "https://drive.google.com/file/d/1fExampleProgC/view",
                label: "üìÑ Cours PDF ‚Äì Programmation C",
              },
              {
                url: "https://drive.google.com/drive/folders/1gExampleProgCFolder",
                label: "üìÅ Dossier ‚Äì Exercices et corrections",
              },
            ],
          },
          {
            title: "Architecture des Ordinateurs",
            resources: [
              {
                url: "https://drive.google.com/file/d/1hExampleArchCours/view",
                label: "üìä Slides ‚Äì Architecture",
              },
            ],
          },
        ],
      },
    },
  },
  licence: {
    label: "Licence",
    description: "Fili√®res professionnalisantes et sp√©cialis√©es.",
    filieres: {
      gi: {
        label: "G√©nie Informatique (GI)",
        description: "D√©veloppement logiciel et syst√®mes.",
        modules: [
          {
            title: "Structures de Donn√©es Avanc√©es",
            resources: [
              {
                url: "https://drive.google.com/file/d/2aExampleSDA/view",
                label: "üìÑ Cours PDF ‚Äì Structures de Donn√©es",
              },
              {
                url: "https://drive.google.com/file/d/2bExampleSDA/view",
                label: "üìù TD ‚Äì Listes et arbres",
              },
            ],
          },
          {
            title: "D√©veloppement Web",
            resources: [
              {
                url: "https://drive.google.com/file/d/2cExampleWebSlides/view",
                label: "üìä Slides ‚Äì HTML &amp; CSS",
              },
              {
                url: "https://drive.google.com/drive/folders/2dExampleWebFolder",
                label: "üìÅ Dossier ‚Äì Projets",
              },
            ],
          },
          {
            title: "Bases de Donn√©es",
            resources: [
              {
                url: "https://drive.google.com/file/d/2eExampleBDD/view",
                label: "üìÑ Cours PDF ‚Äì SQL",
              },
              {
                url: "https://drive.google.com/file/d/2fExampleBDDTP/view",
                label: "üß™ TP ‚Äì Mod√©lisation",
              },
            ],
          },
        ],
      },
      gc: {
        label: "G√©nie Civil (GC)",
        description: "Structures, mat√©riaux et topographie.",
        modules: [
          {
            title: "M√©canique des Structures",
            resources: [
              {
                url: "https://drive.google.com/file/d/2gExampleMeca/view",
                label: "üìÑ Cours PDF ‚Äì M√©canique",
              },
            ],
          },
          {
            title: "R√©sistance des Mat√©riaux",
            resources: [
              {
                url: "https://drive.google.com/file/d/2hExampleRDM/view",
                label: "üìä Slides ‚Äì RDM",
              },
            ],
          },
          {
            title: "Topographie",
            resources: [
              {
                url: "https://drive.google.com/drive/folders/2iExampleTopoFolder",
                label: "üìÅ Dossier ‚Äì Travaux pratiques",
              },
            ],
          },
        ],
      },
    },
  },
  master: {
    label: "Master",
    description: "Programmes sp√©cialis√©s de niveau Bac+5.",
    filieres: {
      msd: {
        label: "Management des Syst√®mes D√©cisionnels (MSD)",
        description: "Business intelligence et gouvernance.",
        modules: [
          {
            title: "Data Warehouse",
            resources: [
              {
                url: "https://drive.google.com/file/d/3aExampleDW/view",
                label: "üìÑ Cours PDF ‚Äì Mod√©lisation multidimensionnelle",
              },
              {
                url: "https://drive.google.com/file/d/3bExampleDWTP/view",
                label: "üß™ TP ‚Äì ETL avec Talend",
              },
            ],
          },
          {
            title: "Data Mining",
            resources: [
              {
                url: "https://drive.google.com/file/d/3cExampleDM/view",
                label: "üìä Slides ‚Äì Classification",
              },
              {
                url: "https://drive.google.com/drive/folders/3dExampleDMFolder",
                label: "üìÅ Dossier ‚Äì Jeux de donn√©es",
              },
            ],
          },
        ],
      },
      sitd: {
        label: "S√©curit√© &amp; Ing√©nierie des Technologies de Donn√©es (SITD)",
        description: "S√©curit√©, Big Data et infrastructures.",
        modules: [
          {
            title: "S√©curit√© R√©seau",
            resources: [
              {
                url: "https://drive.google.com/file/d/3eExampleSecReseau/view",
                label: "üìÑ Cours PDF ‚Äì S√©curit√© r√©seau",
              },
              {
                url: "https://drive.google.com/file/d/3fExampleSecLab/view",
                label: "üß™ TP ‚Äì Pare-feux",
              },
            ],
          },
          {
            title: "Big Data Processing",
            resources: [
              {
                url: "https://drive.google.com/drive/folders/3gExampleBigData",
                label: "üìÅ Dossier ‚Äì TP Spark",
              },
            ],
          },
        ],
      },
    },
  },
  ingenieur: {
    label: "Cycle d‚Äôing√©nieur",
    description: "Formations d‚Äôing√©nieur de la FSTS.",
    filieres: {
      imi: {
        label: "Ing√©nierie M√©catronique et Industrielle (IMI)",
        description: "Automatisation et robotique.",
        modules: [
          {
            title: "Automatique Avanc√©e",
            resources: [
              {
                url: "https://drive.google.com/file/d/4aExampleAuto/view",
                label: "üìÑ Cours PDF ‚Äì Automatique",
              },
              {
                url: "https://drive.google.com/file/d/4bExampleAuto/view",
                label: "üìä Slides ‚Äì Commande PID",
              },
            ],
          },
          {
            title: "Robotique",
            resources: [
              {
                url: "https://drive.google.com/drive/folders/4cExampleRobot",
                label: "üìÅ Dossier ‚Äì Projets",
              },
            ],
          },
        ],
      },
      irssi: {
        label: "Ing√©nierie des R√©seaux et Syst√®mes S√©curis√©s (IRSSI)",
        description: "Syst√®mes, r√©seaux et cybers√©curit√©.",
        modules: [
          {
            title: "Administration Syst√®me Avanc√©e",
            resources: [
              {
                url: "https://drive.google.com/file/d/4dExampleSysAdmin/view",
                label: "üìÑ Cours PDF ‚Äì Linux avanc√©",
              },
            ],
          },
          {
            title: "Audit de S√©curit√©",
            resources: [
              {
                url: "https://drive.google.com/drive/folders/4eExampleAudit",
                label: "üìÅ Dossier ‚Äì Guides d‚Äôaudit",
              },
              {
                url: "https://drive.google.com/file/d/4fExampleAuditSlides/view",
                label: "üìä Slides ‚Äì Outils et m√©thodologie",
              },
            ],
          },
        ],
      },
      qhse: {
        label: "Qualit√©, Hygi√®ne, S√©curit√©, Environnement (QHSE)",
        description: "Gestion des risques et conformit√©.",
        modules: [
          {
            title: "Management QSE",
            resources: [
              {
                url: "https://drive.google.com/file/d/4gExampleQSE/view",
                label: "üìÑ Cours PDF ‚Äì Normes ISO",
              },
            ],
          },
          {
            title: "Gestion de Crise",
            resources: [
              {
                url: "https://drive.google.com/file/d/4hExampleCrisis/view",
                label: "üé• Vid√©o ‚Äì Gestion d‚Äôincident",
              },
            ],
          },
        ],
      },
    },
  },
};

const state = {
  nav: "home",
  group: null,
  filiere: null,
};

const navButtons = Array.from(document.querySelectorAll(".nav-btn"));
const navToggle = document.getElementById("nav-toggle");
const navToggleLabel = document.getElementById("nav-toggle-label");
const navWrapper = document.getElementById("primary-nav");
const heroCta = document.getElementById("hero-cta");
const groupView = document.getElementById("group-view");
const filiereView = document.getElementById("filiere-view");
const modulesView = document.getElementById("modules-view");
const breadcrumb = document.getElementById("breadcrumb");
const breadcrumbHome = document.getElementById("breadcrumb-home");
const breadcrumbGroup = document.getElementById("breadcrumb-group");
const breadcrumbSep = document.getElementById("breadcrumb-sep");
const breadcrumbFiliere = document.getElementById("breadcrumb-filiere");
const explorer = document.getElementById("explorer");

const navLabels = {
  home: "Accueil",
  ...Object.fromEntries(Object.entries(DATA).map(([key, value]) => [key, value.label])),
};

function buildGroupTiles() {
  const fragment = document.createDocumentFragment();
  Object.entries(DATA).forEach(([groupKey, group]) => {
    const button = document.createElement("button");
    button.type = "button";
    button.className = "tile";
    button.dataset.group = groupKey;
    button.innerHTML = `<h3>${group.label}</h3><p>${group.description}</p>`;
    fragment.appendChild(button);
  });
  groupView.appendChild(fragment);
}

function buildFiliereTiles() {
  const fragment = document.createDocumentFragment();
  Object.entries(DATA).forEach(([groupKey, group]) => {
    Object.entries(group.filieres).forEach(([filiereKey, filiere]) => {
      const button = document.createElement("button");
      button.type = "button";
      button.className = "tile";
      button.dataset.group = groupKey;
      button.dataset.filiere = filiereKey;
      button.innerHTML = `<h3>${filiere.label}</h3><p>${filiere.description}</p>`;
      fragment.appendChild(button);
    });
  });
  filiereView.appendChild(fragment);
}

function setActiveNav(target) {
  navButtons.forEach((btn) => {
    const isActive = btn.dataset.target === target;
    btn.classList.toggle("active", isActive);
    btn.setAttribute("aria-pressed", String(isActive));
  });
}

function scrollToExplorer() {
  explorer?.scrollIntoView({ behavior: "smooth", block: "start" });
}

function renderModules(groupKey, filiereKey) {
  modulesView.innerHTML = "";
  if (!groupKey || !filiereKey) {
    return;
  }
  const group = DATA[groupKey];
  const filiere = group?.filieres[filiereKey];
  if (!filiere) {
    return;
  }

  const fragment = document.createDocumentFragment();
  filiere.modules.forEach((module) => {
    const article = document.createElement("article");
    article.className = "module-card";

    const title = document.createElement("h3");
    title.textContent = module.title;
    article.appendChild(title);

    const list = document.createElement("div");
    list.className = "link-list";

    module.resources.forEach((resource) => {
      const link = document.createElement("a");
      link.href = resource.url;
      link.target = "_blank";
      link.rel = "noopener noreferrer";
      link.textContent = resource.label;
      list.appendChild(link);
    });

    article.appendChild(list);
    fragment.appendChild(article);
  });

  modulesView.appendChild(fragment);
}

function updateBreadcrumb() {
  if (state.nav === "home") {
    breadcrumbGroup.classList.add("hidden");
    breadcrumbSep.classList.add("hidden");
    breadcrumbFiliere.classList.add("hidden");
    breadcrumbFiliere.textContent = "";
    return;
  }

  breadcrumbSep.classList.remove("hidden");
  breadcrumbGroup.classList.remove("hidden");
  breadcrumbGroup.textContent = navLabels[state.group] ?? "";

  if (!state.filiere) {
    breadcrumbFiliere.classList.add("hidden");
    breadcrumbFiliere.textContent = "";
  } else {
    breadcrumbFiliere.classList.remove("hidden");
    const label = DATA[state.group]?.filieres[state.filiere]?.label ?? "";
    breadcrumbFiliere.textContent = `‚Ä∫ ${label}`;
  }
}

function render() {
  setActiveNav(state.nav);

  if (state.nav === "home") {
    groupView.classList.remove("hidden");
    filiereView.classList.add("hidden");
    modulesView.classList.add("hidden");
    breadcrumb.classList.add("hidden");
    updateBreadcrumb();
    renderModules(null, null);
    return;
  }

  const groupKey = state.group;
  const filiereKey = state.filiere;

  groupView.classList.add("hidden");
  breadcrumb.classList.remove("hidden");
  updateBreadcrumb();

  if (!filiereKey) {
    filiereView.classList.remove("hidden");
    modulesView.classList.add("hidden");
    Array.from(filiereView.children).forEach((tile) => {
      tile.classList.toggle("hidden", tile.dataset.group !== groupKey);
    });
    renderModules(null, null);
    return;
  }

  filiereView.classList.add("hidden");
  modulesView.classList.remove("hidden");
  renderModules(groupKey, filiereKey);
}

function openMobileNav() {
  navWrapper.classList.add("open");
  navToggle.setAttribute("aria-expanded", "true");
  navToggleLabel.textContent = "Fermer le menu";
}

function closeMobileNav() {
  navWrapper.classList.remove("open");
  navToggle.setAttribute("aria-expanded", "false");
  navToggleLabel.textContent = "Ouvrir le menu";
}

function isMobileView() {
  return window.innerWidth <= 920;
}

buildGroupTiles();
buildFiliereTiles();
render();

document.getElementById("year").textContent = new Date().getFullYear();

heroCta?.addEventListener("click", () => {
  state.nav = "home";
  state.group = null;
  state.filiere = null;
  render();
  scrollToExplorer();
  if (isMobileView()) {
    closeMobileNav();
  }
});

navButtons.forEach((button) => {
  button.addEventListener("click", () => {
    const target = button.dataset.target;
    if (target === "home") {
      state.nav = "home";
      state.group = null;
      state.filiere = null;
    } else {
      state.nav = target;
      state.group = target;
      state.filiere = null;
    }
    render();
    if (target !== "home") {
      scrollToExplorer();
    }
    if (isMobileView()) {
      closeMobileNav();
    }
  });
});

groupView.addEventListener("click", (event) => {
  const tile = event.target.closest(".tile");
  if (!tile) return;
  const { group } = tile.dataset;
  if (!group) return;
  state.nav = group;
  state.group = group;
  state.filiere = null;
  render();
  scrollToExplorer();
});

filiereView.addEventListener("click", (event) => {
  const tile = event.target.closest(".tile");
  if (!tile) return;
  const { group, filiere } = tile.dataset;
  if (!group || !filiere) return;
  state.nav = group;
  state.group = group;
  state.filiere = filiere;
  render();
  scrollToExplorer();
});

breadcrumbHome.addEventListener("click", () => {
  state.nav = "home";
  state.group = null;
  state.filiere = null;
  render();
  if (isMobileView()) {
    closeMobileNav();
  }
});

breadcrumbGroup.addEventListener("click", () => {
  if (!state.group) {
    state.nav = "home";
  } else {
    state.nav = state.group;
  }
  state.filiere = null;
  render();
  scrollToExplorer();
});

if (navToggle) {
  navToggle.addEventListener("click", () => {
    const expanded = navToggle.getAttribute("aria-expanded") === "true";
    if (expanded) {
      closeMobileNav();
    } else {
      openMobileNav();
    }
  });
}

window.addEventListener("resize", () => {
  if (!isMobileView()) {
    closeMobileNav();
  }
});

document.addEventListener("keydown", (event) => {
  if (event.key === "Escape" && navWrapper.classList.contains("open")) {
    closeMobileNav();
  }
});
